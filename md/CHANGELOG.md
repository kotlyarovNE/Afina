# Changelog - Исправление недочетов

## Исправленные проблемы

### ✅ 1. Изменена структура хранения данных

**Проблема:** Все чаты хранились в одном ключе `afina_chats`

**Решение:**
- Создана новая структура хранения с отдельными ключами для каждого чата
- Каждый `chat_id` теперь хранит свои `messages`, `files` (имена файлов), и `typing` состояние
- Добавлена система миграции старых данных
- ID чатов генерируются на основе времени создания: `chat_${timestamp}_${random}`

**Новая структура:**
```typescript
// Метаданные всех чатов
afina_chat_metadata: {
  [chatId]: {
    id: string,
    name: string,
    createdAt: Date,
    updatedAt: Date
  }
}

// Данные конкретного чата
chat_1234567890_abc123: {
  messages: Message[],
  files: string[], // массив имен файлов
  typing: boolean
}

// Все загруженные файлы
afina_uploaded_files: ChatFile[]
```

### ✅ 2. Исправлена дублирующаяся папка uploads

**Проблема:** Были папки `backend/uploads` и `backend/app/uploads`

**Решение:**
- Оставлена только папка `backend/app/uploads`
- Обновлен путь в `backend/app/app.py`

### ✅ 3. Исправлена изоляция сообщений между чатами

**Проблема:** Сообщения появлялись во всех чатах одновременно

**Решение:**
- Каждый чат теперь загружает только свои сообщения из отдельного ключа хранения
- `ChatInterface` теперь управляет своим локальным состоянием сообщений
- Сообщения добавляются в конкретный чат через утилиты `addMessageToChat`, `updateLastMessage`
- При переключении между чатами загружаются только данные текущего чата

### ✅ 4. Добавлено подтверждение удаления чата

**Проблема:** Чаты удалялись без подтверждения

**Решение:**
- Создан компонент `ConfirmDialog` для подтверждающих диалогов
- При нажатии на кнопку удаления показывается диалог с текстом: "Вы точно хотите удалить чат {chat_name}?"
- Добавлены кнопки "Удалить" и "Отмена"
- Красивый дизайн с иконками и цветовым кодированием

## Новые файлы

- `frontend/utils/storage.ts` - Утилиты для работы с новой структурой хранения
- `frontend/components/ConfirmDialog.tsx` - Компонент диалога подтверждения

## Обновленные файлы

- `frontend/types/chat.ts` - Обновлены типы для новой структуры
- `frontend/components/Layout.tsx` - Использует новые утилиты хранения
- `frontend/components/Sidebar.tsx` - Добавлено подтверждение удаления
- `frontend/components/ChatInterface.tsx` - Изолированное управление сообщениями
- `frontend/components/FileManager.tsx` - Работа с новой структурой файлов
- `frontend/pages/chat/[id].tsx` - Использует новые утилиты для отправки сообщений
- `backend/app/app.py` - Исправлен путь к папке uploads

## Технические улучшения

### Миграция данных
- Автоматическая миграция старых данных при первом запуске
- Сохранение всех существующих чатов и файлов
- Безопасное удаление старых ключей после миграции

### Производительность
- Каждый чат загружает только свои данные
- Отсутствие дублирования данных между чатами
- Эффективное управление состоянием печати

### UX улучшения
- Подтверждение важных действий (удаление чата)
- Правильная изоляция контента между чатами
- Сохранение состояния при переключении между чатами

## Как тестировать

1. Запустите приложение: `./start.sh`
2. Создайте несколько чатов с разными именами
3. Отправьте сообщения в разные чаты - убедитесь, что они не дублируются
4. Попробуйте удалить чат - должен появиться диалог подтверждения
5. Загрузите файлы и привяжите их к разным чатам
6. Переключайтесь между чатами - каждый должен показывать только свои сообщения

## Обратная совместимость

Все изменения обратно совместимы. При первом запуске произойдет автоматическая миграция существующих данных в новую структуру без потери информации.
