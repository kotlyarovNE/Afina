# Changelog v2 - Исправление критических недочетов

## ✅ Все исправления выполнены

### 1. Упрощен формат chat_id

**Было:** `chat_1755620649517_f3rc0rweo` (лишняя случайная строка)
**Стало:** `chat_1755620649517` (только timestamp)

**Изменения:**
- Убрана лишняя случайная строка из ID чатов
- ID сообщений теперь содержат chat_id в начале: `1755620649517_1755620649518_abc123`
- Упрощена генерация уникальных идентификаторов

### 2. Исправлена плавная печать от Афины

**Проблемы:**
- ❌ Клиент не видел плавную печать, только индикатор "печатает"
- ❌ После окончания печати текст не отображался до перезагрузки
- ❌ При перезагрузке во время печати `typing=true` оставался навсегда

**Решения:**
- ✅ Добавлено периодическое обновление сообщений каждые 200ms во время печати агента
- ✅ Исправлено отображение потоковых сообщений в реальном времени
- ✅ Добавлен механизм очистки зависшего состояния печати:
  - При загрузке страницы проверяется timestamp последней печати
  - Если прошло >30 секунд, состояние автоматически очищается
- ✅ Добавлено отслеживание времени начала печати для предотвращения зависания

### 3. Упрощена система файлов

**Было:**
- Дублирующийся ключ `afina_uploaded_files` в localStorage
- Файлы создавались в отдельных папках по chat_id
- Сложная система управления файлами

**Стало:**
- Все файлы хранятся в одной папке `backend/app/uploads`
- Файлы загружаются через API `POST /api/upload`
- Список файлов получается через API `GET /api/files`
- Удаление через API `DELETE /api/files/{filename}`
- В chat_id хранятся только имена привязанных файлов

**Новая архитектура файлов:**
```
backend/app/uploads/           # Все файлы здесь
├── document1.pdf
├── report_1755620649517.docx  # С timestamp если дубликат
└── data.xlsx

LocalStorage:
chat_1755620649517: {
  messages: [...],
  files: ["document1.pdf", "report_1755620649517.docx"], // Только имена
  typing: false
}
```

## Новые API endpoints

### POST /api/upload
Загрузка файла в общую папку uploads
- Автоматическое переименование при дубликатах (добавляется timestamp)
- Возвращает информацию о загруженном файле

### GET /api/files  
Получение всех загруженных файлов
- Сортировка по дате загрузки (новые первые)
- Информация о размере и времени загрузки

### DELETE /api/files/{filename}
Удаление файла из папки uploads
- Автоматическое удаление из всех чатов

## Технические улучшения

### Исправления потоковой печати
```typescript
// Периодическое обновление во время печати
useEffect(() => {
  if (!isAgentTyping) return;
  
  const interval = setInterval(() => {
    loadChatData();
  }, 200); // Обновляем каждые 200ms

  return () => clearInterval(interval);
}, [isAgentTyping, chat.id]);
```

### Защита от зависания печати
```typescript
const clearTypingStateOnPageLoad = async (chatId: string) => {
  const lastTypingTime = await localforage.getItem(`${chatId}_typing_timestamp`);
  const now = Date.now();
  
  if (lastTypingTime && (now - lastTypingTime) > 30000) {
    // Прошло больше 30 секунд, очищаем состояние
    await setTypingState(chatId, false);
  }
};
```

### Упрощенная система файлов
```typescript
// Загрузка файла на сервер
export const uploadFile = async (file: File): Promise<ChatFile> => {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch('http://localhost:8000/api/upload', {
    method: 'POST',
    body: formData,
  });
  
  // Файл сохраняется в backend/app/uploads
  return await response.json();
};
```

## Структура данных после исправлений

### Chat ID
```
Формат: chat_{timestamp}
Пример: chat_1755620649517
```

### Message ID  
```
Формат: {chat_timestamp}_{message_timestamp}_{random}
Пример: 1755620649517_1755620649518_abc123
```

### Хранение чатов
```typescript
// Метаданные
afina_chat_metadata: {
  "chat_1755620649517": {
    id: "chat_1755620649517",
    name: "Анализ отчета",
    createdAt: "2024-01-01T10:00:00Z",
    updatedAt: "2024-01-01T10:30:00Z"
  }
}

// Данные чата
chat_1755620649517: {
  messages: [
    {
      id: "1755620649517_1755620649518_abc123",
      content: "Привет!",
      sender: "user",
      timestamp: "2024-01-01T10:00:00Z"
    }
  ],
  files: ["report.docx", "data.xlsx"], // Только имена файлов
  typing: false
}
```

### Файловая система
```
backend/app/uploads/
├── report.docx              # Оригинальное имя
├── data_1755620649517.xlsx  # С timestamp при дубликате  
└── document.pdf
```

## Тестирование

1. **Создайте несколько чатов** - ID должны быть вида `chat_1234567890`
2. **Отправьте сообщение** - должна появиться плавная печать от Афины
3. **Во время печати переключитесь на другой чат** - печать должна продолжиться в фоне
4. **Перезагрузите страницу во время печати** - состояние должно очиститься через 30 секунд
5. **Загрузите файлы** - они должны появиться в `backend/app/uploads`
6. **Привяжите файлы к чатам** - в чате должны отображаться только привязанные файлы

## Обратная совместимость

Все изменения обратно совместимы. Существующие чаты будут автоматически мигрированы в новую структуру при первом запуске.
